<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>관리자 · 멘토 출석/일지 시스템</title>
<style>
  *{box-sizing:border-box}
  body{margin:0;font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f4f6f9;color:#111}
  header{background:#fff;border-bottom:1px solid #ddd;padding:16px;text-align:center;font-weight:800;letter-spacing:-.2px}
  nav{display:flex;flex-wrap:wrap;background:#fff;border-bottom:1px solid #ddd}
  main{max-width:980px;margin:0 auto;padding:16px}
  .card{background:#fff;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .muted{color:#666;font-size:12px}
  label{display:block;font-size:13px;margin-top:10px;font-weight:700}
  input,textarea,select{width:100%;padding:10px;margin-top:6px;border:1px solid #cfd6e0;border-radius:10px;font-size:14px;background:#fff}
  textarea{min-height:96px;resize:vertical}
  .row{display:flex;gap:8px;align-items:flex-start}
  .row > *{flex:1;min-width:0}
  .chk{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
  .chk label{margin-top:0;font-weight:600}
  .btn{margin-top:14px;width:100%;padding:12px;border:none;border-radius:10px;font-size:14px;cursor:pointer}
  .btn.primary{background:#2f5bea;color:#fff;font-weight:800}
  .btn.ghost{background:#eef2ff;color:#2f5bea;font-weight:800}
  .btn-sm{padding:8px 10px;border-radius:9px;border:1px solid #d6dbe6;background:#fff;cursor:pointer;font-size:12px}
  .btn-sm.primary{background:#2f5bea;border-color:#2f5bea;color:#fff;font-weight:800}
  .btn-sm.danger{background:#ffecec;border-color:#ffd0d0;color:#b00020;font-weight:800}
  .actions{display:flex;gap:8px;flex-wrap:wrap}
  table.basic{width:100%;border-collapse:collapse;font-size:13px}
  table.basic th, table.basic td{border:1px solid #d6dbe6;padding:10px;vertical-align:top}
  table.basic th{background:#f7f9fc;text-align:center;white-space:nowrap}

  /* modals */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
  .modal{background:#fff;border-radius:14px;width:min(1100px,100%);height:min(92vh,900px);display:flex;flex-direction:column;overflow:hidden}
  .modal-hd{padding:12px 14px;border-bottom:1px solid #eee;display:flex;align-items:center;justify-content:space-between;gap:10px}
  .modal-hd b{font-size:14px}
  .modal-bd{flex:1;background:#fafafa}
  iframe{width:100%;height:100%;border:0;background:#fff}
  .modal-ft{padding:12px 14px;border-top:1px solid #eee;display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}

  @media print {
    nav, header, .no-print, .backdrop {display:none !important}
    body{background:#fff}
  }
/* 멘티 선택: 과목 선택 전 비활성화 */
#menteeSection.disabled{opacity:.45;pointer-events:none}
#menteeGuide{display:none;margin:-6px 0 8px;color:#666;font-size:13px}

.isHidden{display:none!important}
.extra-guide{font-size:12px;color:#666;margin-top:6px}

.mentee-guide{
  margin-top:8px;
  font-size:13px;
  color:#666;
}


.mentee-title{
  margin-bottom:32px;
}


.mentee-guide{
  margin-top:32px;   /* 제목과 설명 사이를 확실히 분리 */
  line-height:1.5;
}


/* ✅ 모바일: (관리자) 멘티 체크리스트 터치 간격 개선 */
@media (max-width: 600px){
  #editMenteeChecklist label,
  #menteeChecklist label{
    display:flex;
    align-items:center;
    gap:10px;
    padding:12px 0;
    margin:0;
  }
  #editMenteeChecklist input[type="checkbox"],
  #menteeChecklist input[type="checkbox"]{
    transform: scale(1.2);
    transform-origin: left center;
  }
}

/* 관리자 전용 부드러운 안내 */
.admin-guide{
  margin-top: 6px;
  margin-bottom: 12px;
  padding: 14px 14px;
  border-radius: 14px;
  background: #f7f9ff;
  border: 1px solid #dbe3ff;
  color: #1c2f7a;
  font-size: 13px;
  line-height: 1.6;
}
.admin-guide b{font-weight: 800}
.admin-guide-link{
  font-weight: 700;
  color: #2f5bea;
  text-decoration: underline;
}

</style>
</head>
<body>
<header>관리자 · 멘토 출석/일지 시스템</header>

<nav class="no-print" aria-label="주요 메뉴">
  <a class="btn-sm primary" href="index.html" style="margin:8px 12px; text-decoration:none; display:inline-flex; align-items:center;">← 메인으로</a>
</nav>

<main>
  <section id="admin" class="active">
    <div class="card">
      <div class="admin-guide" role="note" aria-label="관리자 전용 안내">
        <b>안내</b><br/>
        이 페이지는 관리자 전용 기능을 제공합니다.<br/>
        일반 멘토는 <a href="index.html" class="admin-guide-link">메인 페이지</a>에서 출석 및 활동일지를 이용해 주세요.
      </div>

      <label for="adminEmail">관리자 이메일</label>
      <input type="email" id="adminEmail" placeholder="예) admin@example.com" autocomplete="username" />

      <label for="adminPw">관리자 비밀번호</label>
      <input type="password" id="adminPw" placeholder="비밀번호 입력" autocomplete="current-password" />

      <button class="btn primary" id="adminLogin" type="button">로그인</button>
      <button class="btn ghost" id="adminLogout" type="button" style="display:none">로그아웃</button>

      <div class="muted" style="margin-top:10px">* 관리자 계정으로 로그인해야 조회/수정/출력 기능이 보입니다.</div>
    </div>

    <div class="card" id="adminPanel" style="display:none">
      <h3 style="margin:0 0 8px 0">출력 옵션</h3>

      <div class="row">
        <div>
          <label for="optMentor">멘토명</label>
          <input id="optMentor" list="mentorList" placeholder="멘토명 입력/선택 (비우면 전체)" />
          <datalist id="mentorList"></datalist>
        </div>
        <div>
          <label for="optField">분야</label>
          <select id="optField">
            <option value="전체">전체</option>
            <option value="고졸">고졸</option>
            <option value="중졸">중졸</option>
            <option value="초졸">초졸</option>
            <option value="기초학습">기초학습</option>
            <option value="상주멘토링">상주멘토링</option>
          </select>
        </div>
        <div>
          <label for="optSubject">과목</label>
          <select id="optSubject">
            <option value="전체">전체</option>
            <option value="국어">국어</option>
            <option value="영어">영어</option>
            <option value="수학">수학</option>
            <option value="사회">사회</option>
            <option value="과학">과학</option>
            <option value="한국사">한국사</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnSearchAdmin" type="button">조회하기</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn ghost" id="btnPreview" type="button">미리보기</button>
        <button class="btn primary" id="btnPrintAll" type="button">출력(새 창)</button>
      </div>

      <div class="muted" style="margin-top:10px">• 출력은 “요약 1페이지 + 선택된 일지들(페이지 자동 분리)”로 생성됩니다.</div>
    </div>

    <div class="card" id="adminListCard" style="display:none">
      <div class="row" style="align-items:center">
        <h3 style="margin:0">활동일지 목록</h3>
        <div class="actions" style="justify-content:flex-end">
          <button class="btn-sm" id="btnRefreshAdmin" type="button">새로고침</button>
          <button class="btn-sm danger" id="btnClearAll" type="button">전체 삭제</button>
        </div>
      </div>

      <div style="margin-top:10px; overflow:auto">
        <table class="basic">
          <thead>
            <tr>
              <th>멘토</th>
              <th>활동일</th>
              <th>요약</th>
              <th>미리보기/출력</th>
            </tr>
          </thead>
          <tbody id="adminTable"></tbody>
        </table>
      </div>
    </div>

    <div class="card" id="adminStatsCard" style="display:none">
      <div class="muted" style="margin-top:0">※ 저장된 활동일지를 기준으로 자동 집계됩니다. (멘티는 쉼표/줄바꿈으로 입력된 이름을 기준으로 1회기씩 카운트)</div>

      <div style="margin-top:12px; overflow:auto">
        <table class="basic">
          <tbody id="statsSummary"></tbody>
        </table>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <h4 style="margin:0 0 6px 0">멘토 · 분야별 회기</h4>
        <table class="basic">
          <thead><tr><th>멘토</th><th>분야</th><th>회기</th><th>누적 시간</th></tr></thead>
          <tbody id="statsByMentor"></tbody>
        </table>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <h4 style="margin:0 0 6px 0">멘티별 출석(회기)</h4>
        <table class="basic">
          <thead><tr><th>멘티</th><th>총 회기</th></tr></thead>
          <tbody id="statsByMentee"></tbody>
        </table>
      </div>

      <div style="margin-top:12px; overflow:auto">
        <h4 style="margin:0 0 6px 0">멘토-멘티별 출석(회기)</h4>
        <table class="basic">
          <thead><tr><th>멘토</th><th>멘티</th><th>회기</th></tr></thead>
          <tbody id="statsByPair"></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- preview modal -->
<div class="backdrop" id="previewBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="출력 미리보기">
    <div class="modal-hd">
      <b>출력 미리보기</b>
      <button class="btn-sm" id="btnClosePreview" type="button">닫기</button>
    </div>
    <div class="modal-bd">
      <iframe id="previewFrame" title="미리보기"></iframe>
    </div>
    <div class="modal-ft">
      <button class="btn-sm primary" id="btnPrintFromPreview" type="button">이대로 출력</button>
    </div>
  </div>
</div>

<!-- edit modal -->
<div class="backdrop" id="editBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="일지 수정">
    <div class="modal-hd">
      <b>일지 수정</b>
      <button class="btn-sm" id="btnCloseEdit" type="button">닫기</button>
    </div>
    <div class="modal-bd" style="background:#fff;overflow:auto">
      <div style="padding:14px">
        <div class="muted" id="editHint" style="margin-bottom:10px"></div>

        <label style="font-weight:700;font-size:13px">멘토 이름</label>
        <input id="editMentorName" />

        <label style="font-weight:700;font-size:13px">멘토 생년월일(YYYY-MM-DD)</label>
        <input id="editMentorBirth" placeholder="예) 2000-01-23" inputmode="numeric" />

        <label style="font-weight:700;font-size:13px">활동 날짜(YYYY-MM-DD)</label>
        <input id="editDate" placeholder="예) 2025-05-11" inputmode="numeric" />

        <label style="font-weight:700;font-size:13px">시작 시간</label>
        <input id="editStart" placeholder="1530 또는 15:30" inputmode="numeric" />

        <label style="font-weight:700;font-size:13px">종료 시간</label>
        <input id="editEnd" placeholder="1730 또는 17:30" inputmode="numeric" />

        <label style="font-weight:700;font-size:13px">활동 장소</label>
        <div class="row">
          <select id="editPlaceMode">
            <option value="">선택</option>
            <option value="대면">대면</option>
            <option value="비대면">비대면</option>
          </select>
          <select id="editPlaceDetail">
            <option value="">(대면 시) 장소 선택</option>
            <option value="탄탄대로실(3층)">탄탄대로실(3층)</option>
            <option value="도서관(3층)">도서관(3층)</option>
            <option value="상담실(3층)">상담실(3층)</option>
            <option value="상담실(2층)">상담실(2층)</option>
            <option value="라온실(B1층)">라온실(B1층)</option>
          </select>
        <div id="editPlaceGuide" style="display:none;font-size:12px;color:#666;margin-top:6px">비대면은 장소 선택이 필요 없어요.</div>
        </div>

        <label style="font-weight:700;font-size:13px">활동 분야</label>
        <select id="editField">
          <option value="">선택</option>
          <option value="고졸">고졸</option>
          <option value="중졸">중졸</option>
          <option value="초졸">초졸</option>
          <option value="기초학습">기초학습</option>
          <option value="상주멘토링">상주멘토링</option>
        </select>

        <label style="font-weight:700;font-size:13px">과목</label>
        <select id="editSubject">
          <option value="">선택</option>
          <option value="국어">국어</option>
          <option value="영어">영어</option>
          <option value="수학">수학</option>
          <option value="사회">사회</option>
          <option value="과학">과학</option>
          <option value="한국사">한국사</option>
        </select>

        <label style="font-weight:700;font-size:13px">활동 내용</label>
        <textarea id="editContent" style="min-height:160px"></textarea>

        <label style="font-weight:700;font-size:13px">활동 소감</label>
        <textarea id="editReflection" style="min-height:100px"></textarea>

        <label style="font-weight:700;font-size:13px">오늘의 활동 만족도(1~5)</label>
        <select id="editRating">
          <option value="0">선택 안 함</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>

        <label style="font-weight:700;font-size:13px">멘티 선택</label>
        <div class="row" style="gap:10px; align-items:center">
          <input id="editMenteeSearch" placeholder="멘티 검색 (이름 일부)" style="flex:2" />
          <button class="btn-sm" id="btnEditMenteeAll" type="button">전체 선택</button>
          <button class="btn-sm" id="btnEditMenteeClear" type="button">전체 해제</button>
        </div>
        <textarea id="editMentees" readonly style="min-height:80px" placeholder="아래 체크리스트에서 멘티를 선택해 주세요."></textarea>
        <div id="editMenteeChecklist" class="chk" style="margin-top:10px;"></div>
        <div class="muted">* 정해진 명단에서만 선택됩니다.</div>



        <label style="font-weight:700;font-size:13px">요청사항</label>
        <textarea id="editRequest" style="min-height:100px"></textarea>

        <label style="font-weight:700;font-size:13px">다음 멘토링 일정</label>
        <select id="editNext">
          <option value="">선택</option>
          <option value="변동 없습니다">변동 없습니다</option>
          <option value="변동 필요합니다">변동 필요합니다</option>
        </select>
      </div>
    </div>
    <div class="modal-ft">
      <button class="btn-sm danger" id="btnCancelEdit" type="button">취소</button>
      <button class="btn-sm primary" id="btnSaveEdit" type="button">저장</button>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict';
  const $ = (id) => document.getElementById(id);
  // ---------- utils ----------
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
  }
  function normalizeTime(raw){
    const v = String(raw||'').trim();
    if (/^\d{4}$/.test(v)) return v.slice(0,2) + ':' + v.slice(2);
    if (/^\d{2}:\d{2}$/.test(v)) return v;
    if (/^\d{1,2}:\d{2}$/.test(v)) {
      const [h,m]=v.split(':');
      return String(h).padStart(2,'0')+':'+m;
    }
    return v;
  }
  function timeToMinutes(t){
    const v = normalizeTime(t);
    if(!/^\d{2}:\d{2}$/.test(v)) return null;
    const [h,m] = v.split(':').map(Number);
    if(Number.isNaN(h)||Number.isNaN(m)) return null;
    return h*60+m;
  }
  function calcTotal(start, end){
    const s = timeToMinutes(start);
    const e = timeToMinutes(end);
    if(s==null || e==null) return '';
    const diff = Math.max(0, e-s);
    const hh = Math.floor(diff/60);
    const mm = diff%60;
    return `${hh}시간 ${mm}분`;
  }
  function minutesBetween(start, end){
    const s = timeToMinutes(start);
    const e = timeToMinutes(end);
    if(s==null || e==null) return 0;
    return Math.max(0, e-s);
  }
  function minutesToText(mins){
    const hh = Math.floor(mins/60);
    const mm = mins%60;
    return `${hh}시간 ${mm}분`;
  }
  function parseMentees(text){
    const raw = String(text||'');
    const tokens = raw.split(/[\n,]/g).map(s => s.trim()).filter(Boolean);
    const seen = new Set();
    const out = [];
    for(const t of tokens){ if(!seen.has(t)){ seen.add(t); out.push(t); } }
    return out;
  }
  function stars(n){
    const k = Math.max(0, Math.min(5, parseInt(n||0,10) || 0));
    return '★★★★★'.slice(0,k) + '☆☆☆☆☆'.slice(0,5-k);
  }
  function formatDateWithDay(dateStr){ return String(dateStr||'').replace(/-/g,'.'); }

  
  function formatDateWithDay(dateStr){
    if(!dateStr) return '';
    const parts = String(dateStr).split('-').map(Number);
    if(parts.length !== 3 || parts.some(n => Number.isNaN(n))) return String(dateStr);

    const [y, m, d] = parts;
    // ✅ 로컬 기준 날짜 생성 (타임존/브라우저 차이로 요일 틀어지는 것 방지)
    const date = new Date(y, m - 1, d);

    const days = ['일','월','화','수','목','금','토'];
    const dow = days[date.getDay()];

    const mm = String(m).padStart(2,'0');
    const dd = String(d).padStart(2,'0');

    return `${y}.${mm}.${dd}(${dow})`;
  }
// ---------- output option ----------
  function getOutputOption(){
    const mentorRaw = ($('optMentor')?.value || '').trim();
    return {
      mentor: mentorRaw || '전체',
      field: ($('optField')?.value || '전체').trim() || '전체',
      subject: ($('optSubject')?.value || '전체').trim() || '전체'
    };
  }

  // ---------- data ----------
  function getLogs(){
  return window.__adminLogs || [];
}

  // =========================
  // 멘티 체크리스트 (정해진 명단만)
  // =========================
  const MENTEES = [
    // ✅ 여기만 네 멘티로 바꾸면 돼요
  { name: "임경환", field: "고졸", subject: "국어" },
  { name: "조민희", field: "고졸", subject: "국어" },
  { name: "정제헌", field: "고졸", subject: "국어" },
  { name: "홍주현", field: "고졸", subject: "국어" }, 
  { name: "김형준", field: "기초학습", subject: "수학" },
  { name: "박수빈", field: "기초학습", subject: "수학" },
  { name: "박소민", field: "기초학습", subject: "수학" },
  { name: "이혜원", field: "기초학습", subject: "수학" },
  { name: "유지수", field: "기초학습", subject: "수학" },
  { name: "정태성", field: "기초학습", subject: "수학" },
  { name: "양민철", field: "기초학습", subject: "수학" },
  { name: "김서희", field: "기초학습", subject: "수학" },
  { name: "고은사랑", field: "고졸", subject: "수학" },
  { name: "이시은", field: "고졸", subject: "수학" },
  { name: "윤여운", field: "고졸", subject: "수학" },
  { name: "홍주현", field: "고졸", subject: "수학" },  
  { name: "김형준", field: "고졸", subject: "영어" },
  { name: "김서희", field: "고졸", subject: "영어" },
  { name: "서예령", field: "고졸", subject: "영어" },
  { name: "조민우", field: "고졸", subject: "영어" },
  { name: "정태성", field: "고졸", subject: "영어" },
  { name: "정제헌", field: "고졸", subject: "영어" },
  { name: "고수진", field: "고졸", subject: "한국사" },
  { name: "신현주", field: "고졸", subject: "한국사" },
  { name: "이정원", field: "고졸", subject: "한국사" },
  { name: "유지수", field: "고졸", subject: "한국사" },
  { name: "임경환", field: "고졸", subject: "한국사" },
  { name: "유시은", field: "고졸", subject: "한국사" },
  { name: "장은호", field: "고졸", subject: "한국사" },
  { name: "장희재", field: "고졸", subject: "한국사" },
  { name: "조민희", field: "고졸", subject: "한국사" },
  { name: "김영우", field: "중졸", subject: "수학" },
  { name: "김수아", field: "중졸", subject: "수학" },
  { name: "송지은", field: "중졸", subject: "수학" },
  { name: "최시언", field: "초졸", subject: "수학" } 
  ];

  function normalize(v){ return (v || '').trim(); }

  function filterMentees(field, subject){
    const f = normalize(field);
    const s = normalize(subject);
    return MENTEES.filter(m => {
      if(f && m.field !== f) return false;
      if(s && m.subject !== s) return false;
      return true;
    });
  }

  function uniqueNames(list){
    const seen = new Set();
    const out = [];
    for(const m of list){
      const n = m?.name;
      if(!n || seen.has(n)) continue;
      seen.add(n);
      out.push(n);
    }
    return out;
  }

  // ✅ 전체(모든 과목/분야) '정해진 멘티' 이름 Set (추가 인원 판별용)
  const ALL_PRESET_NAME_SET = new Set(uniqueNames(MENTEES));

  function getEditSearchQuery(){
    const q = $('editMenteeSearch')?.value || '';
    return q.trim();
  }

  function getAllowedMenteeSet(field, subject){
    const list = filterMentees(field, subject);
    return new Set(uniqueNames(list));
  }

  function renderEditMenteeChecklist(){
    const wrap = $('editMenteeChecklist');
    if(!wrap) return;

    const field = $('editField')?.value || "";
    const subject = ($('editField')?.value === '상주멘토링') ? "" : ($('editSubject')?.value || "");
    const q = getEditSearchQuery();

    const names = Array.from(getAllowedMenteeSet(field, subject))
      .filter(n => !q || n.includes(q));

    if(!names.length){
      wrap.innerHTML = "<span class='muted'>조건/검색에 맞는 멘티가 없습니다.</span>";
      return;
    }

    const selected = new Set(parseMentees($('editMentees')?.value || ""));
    wrap.innerHTML = names.map(name => {
      const checked = selected.has(name) ? "checked" : "";
      return `<label><input type="checkbox" value="${name}" ${checked}> ${name}</label>`;
    }).join("");

    const syncPickedToTextarea = () => {
      const picked = Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked')).map(x => x.value);
      $('editMentees').value = picked.join(', ');
    };

    wrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      cb.addEventListener('change', syncPickedToTextarea);
    });
  }

  function setLogs(logs){
    window.__adminLogs = Array.isArray(logs) ? logs : [];
  }

  // ---------- mentor options (datalist) ----------
  function populateMentorOptions(){
    const logs = getLogs();
    const names = Array.from(new Set(logs.map(l => l?.mentor?.name).filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b),'ko'));
    const dl = $('mentorList');
    if(!dl) return;
    dl.innerHTML =
      '<option value="전체"></option>' +
      names.map(n => `<option value="${escapeHtml(n)}"></option>`).join('');
  }

  // ---------- filtering ----------
  function filterLogs(allLogs, opt){
    return (allLogs||[]).filter(l => {
      if(opt.mentor && opt.mentor !== '전체' && (l.mentor?.name||'') !== opt.mentor) return false;
      if(opt.field && opt.field !== '전체' && (l.field||'') !== opt.field) return false;
      if(opt.subject && opt.subject !== '전체') {
        if((l.field||'') === '상주멘토링') return false;
        if((l.subject||'') !== opt.subject) return false;
      }
      return true;
    });
  }
  function assignSessions(filtered){
    const logs = [...filtered].sort((a,b) => (a.date||'').localeCompare(b.date||''));
    const counts = new Map();
    return logs.map(l => {
      const mentorName = l.mentor?.name || '';
      const field = l.field || '';
      const subject = (field === '상주멘토링') ? '' : (l.subject || '');
      const key = `${mentorName}|${field}|${subject}`;
      const next = (counts.get(key) || 0) + 1;
      counts.set(key, next);
      return Object.assign({}, l, { session: next });
    });
  }
  function getTotalTime(logs){
    let totalMin = 0;
    for(const l of (logs||[])) totalMin += minutesBetween(l.start, l.end);
    return minutesToText(totalMin);
  }

  // ---------- table ----------
  let currentFiltered = null; // last "조회하기" result

  function renderAdminTable(list){
    const logs = Array.isArray(list) ? list : getLogs();
    const tbody = $('adminTable');
    if(!tbody) return;

    if(!logs.length){
      tbody.innerHTML = `<tr><td colspan="4">저장된 일지가 없습니다.</td></tr>`;
      return;
    }

    tbody.innerHTML = logs.map((l,i)=>({l,i}))
      .sort((a,b)=> (b.l.date||'').localeCompare(a.l.date||'') || (b.i-a.i))
      .map(({l,i}) => {
        const mentees = Array.isArray(l.mentees) ? l.mentees.join(', ') : '';
        const summary = `멘티: ${mentees}${l.field ? ' · ' + l.field : ''}${(l.field!=='상주멘토링' && l.subject) ? ' / ' + l.subject : ''}`;
        return `<tr>
          <td>${escapeHtml(l.mentor?.name||'')}</td>
          <td>${escapeHtml(formatDateWithDay(l.date||''))}</td>
          <td>${escapeHtml(summary)}</td>
          <td>
            <div class="actions">
              <button class="btn-sm" data-action="single" data-id="${l.id}">단일 미리보기</button>
              <button class="btn-sm primary" data-action="singlePrint" data-id="${l.id}">단일 출력</button>
              <button class="btn-sm" data-action="edit" data-id="${l.id}">수정</button>
              <button class="btn-sm danger" data-action="del" data-id="${l.id}">삭제</button>
            </div>
          </td>
        </tr>`;
      }).join('');
  }

  // ---------- stats ----------
  function renderStats(){
    const logs = getLogs();
    const sumEl = $('statsSummary');
    const byMentorEl = $('statsByMentor');
    const byMenteeEl = $('statsByMentee');
    const byPairEl = $('statsByPair');
    if(!sumEl || !byMentorEl || !byMenteeEl || !byPairEl) return;

    if(!logs.length){
      sumEl.innerHTML = `<tr><th>요약</th><td>저장된 일지가 없습니다.</td></tr>`;
      byMentorEl.innerHTML = `<tr><td colspan="4">-</td></tr>`;
      byMenteeEl.innerHTML = `<tr><td colspan="2">-</td></tr>`;
      byPairEl.innerHTML = `<tr><td colspan="3">-</td></tr>`;
      return;
    }

    let totalMin = 0;
    for(const l of logs) totalMin += minutesBetween(l.start, l.end);

    const mentorFieldMap = new Map(); // mentor||field -> {mentor, field, sessions, minutes}
    const menteeMap = new Map(); // mentee -> sessions
    const pairMap = new Map();   // mentor||mentee -> sessions

    for(const l of logs){
      const mentor = l.mentor?.name || '';
      const mins = minutesBetween(l.start, l.end);

      if(mentor){
        const field = (l.field && String(l.field).trim()) ? String(l.field).trim() : '미분류';
        const key = `${mentor}||${field}`;
        const cur = mentorFieldMap.get(key) || { mentor, field, sessions:0, minutes:0 };
        cur.sessions += 1;
        cur.minutes += mins;
        mentorFieldMap.set(key, cur);
      }

      const mentees = Array.isArray(l.mentees) ? l.mentees : [];
      for(const mm of mentees){
        const mentee = String(mm||'').trim();
        if(!mentee) continue;
        menteeMap.set(mentee, (menteeMap.get(mentee)||0) + 1);

        if(mentor){
          const key = `${mentor}||${mentee}`;
          pairMap.set(key, (pairMap.get(key)||0) + 1);
        }
      }
    }

    sumEl.innerHTML = `
      <tr><th style="width:35%">총 일지 수</th><td>${logs.length}건</td></tr>
      <tr><th>총 활동 회기</th><td>${logs.length}회기</td></tr>
      <tr><th>총 누적시간</th><td>${escapeHtml(minutesToText(totalMin))}</td></tr>
      <tr><th>멘토 수</th><td>${new Set(Array.from(mentorFieldMap.values()).map(v=>v.mentor)).size}명</td></tr>
      <tr><th>멘티 수</th><td>${menteeMap.size}명</td></tr>
    `;

    const rows = Array.from(mentorFieldMap.values())
      .sort((a,b)=> b.sessions - a.sessions || a.mentor.localeCompare(b.mentor,'ko') || a.field.localeCompare(b.field,'ko'));

    byMentorEl.innerHTML = rows.map(r => `
      <tr>
        <td>${escapeHtml(r.mentor)}</td>
        <td>${escapeHtml(r.field)}</td>
        <td style="text-align:right">${r.sessions}회기</td>
        <td style="text-align:right">${escapeHtml(minutesToText(r.minutes))}</td>
      </tr>
    `).join('') || `<tr><td colspan="4">-</td></tr>`;

    const mentees = Array.from(menteeMap.entries()).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'ko'));
    byMenteeEl.innerHTML = mentees.map(([name, c]) => `
      <tr>
        <td>${escapeHtml(name)}</td>
        <td style="text-align:right">${c}회기</td>
      </tr>
    `).join('') || `<tr><td colspan="2">-</td></tr>`;

    const pairs = Array.from(pairMap.entries()).map(([k,c]) => {
      const [mentor, mentee] = k.split('||');
      return { mentor, mentee, c };
    }).sort((a,b)=> b.c-a.c || a.mentor.localeCompare(b.mentor,'ko') || a.mentee.localeCompare(b.mentee,'ko'));

    byPairEl.innerHTML = pairs.map(p => `
      <tr>
        <td>${escapeHtml(p.mentor)}</td>
        <td>${escapeHtml(p.mentee)}</td>
        <td style="text-align:right">${p.c}회기</td>
      </tr>
    `).join('') || `<tr><td colspan="3">-</td></tr>`;
  }

  // ---------- print html ----------
  function buildPrintHTML(allLogs, option){
    const opt = {
      mentor: (option.mentor || '전체').trim() || '전체',
      field: (option.field || '전체').trim() || '전체',
      subject: (option.subject || '전체').trim() || '전체'
    };

    const filtered = filterLogs(allLogs, opt);
    if(!filtered.length){
      return `<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8"><title>출력</title></head>
      <body style="font-family:'Noto Sans KR',sans-serif;padding:24px">
        <h3>출력할 일지가 없습니다</h3>
        <p>관리자 출력 옵션을 확인해 주세요.</p>
      </body></html>